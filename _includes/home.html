<!-- This is a restricted API key and cannot be used on any other site other than this one. -->
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAxsydycQ9ybjv0RSC3TNd_n_AS-m4dbU4"></script>
<script type="text/javascript">
    window.onload = function () {
        LoadMap();
    }
    function LoadMap() {
        return retrievePlots().then(markers => {
            var mapOptions = {
                center: new google.maps.LatLng(markers[0].lat, markers[0].lng),
                zoom: 8,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var infoWindow = new google.maps.InfoWindow();
            var latlngbounds = new google.maps.LatLngBounds();
            var map = new google.maps.Map(document.getElementById("dvMap"), mapOptions);

            updateIncidentCount(markers.length);
     
            for (var thisMarker of markers) {
                var data = thisMarker
                var myLatlng = new google.maps.LatLng(data.lat, data.lng);
                var marker = new google.maps.Marker({
                    position: myLatlng,
                    map: map,
                    title: data.title
                });
                (function (marker, data) {
                    google.maps.event.addListener(marker, "click", function (e) {
                        infoWindow.setContent("<div style = 'width:200px;min-height:40px'>" + data.description + "</div>");
                        infoWindow.open(map, marker);
                    });
                })(marker, data);
                latlngbounds.extend(marker.position);
            }
            var bounds = new google.maps.LatLngBounds();
            map.setCenter(latlngbounds.getCenter());
            map.fitBounds(latlngbounds);
        });
    }

    function retrievePlots() {
        const urlSearchParams = new URLSearchParams(window.location.search);
        const params = Object.fromEntries(urlSearchParams.entries());
        const incidentsUrl = new URL("https://belmont-police-blotter-functions.vercel.app/api/index");
        Object.keys(params).forEach(key => incidentsUrl.searchParams.append(key, params[key]));

        return fetch(incidentsUrl).
            then(response => response.json()).
            then(data => {
                return data.items.map(({ date, number, latitude, longitude, type }) => {
                    const realDate = new Date(date);
                    const year = realDate.getFullYear();
                    const month = (realDate.getMonth() + 1).toString().padStart(2, "0");
                    const day = realDate.getDate().toString().padStart(2, "0");

                    return {
                        "title": `Incident: ${number}`,
                        "lat": latitude,
                        "lng": longitude,
                        "description": `Type: ${type}<br> More information: <a href='/belmont-police-blotter/incidents/${year}/${month}/${day}/${number}'>${number}</a>`,
                    }
                })
            }).
            catch((err) => {
              console.log(`Error: ${err}` )
            });
    }

    function updateIncidentCount(count) {
        const countContainer = document.getElementById("incident-count");

        if (countContainer) {
            countContainer.innerText = count.toLocaleString();
        }
    }
</script>
<h3><span id="incident-count"></span> Incidents:</h3>
<div id="dvMap" style="width: 700px; height: 500px">
</div>
